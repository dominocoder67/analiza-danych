---
title: "analiza danych - samochody"
author: "Dominik Bartosiak, Damian Damięcki, Mikołaj Kustusz"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
if (!require(tidyverse)) install.packages("tidyverse")
if (!require(dplyr)) install.packages("dplyr")
if (!require(naniar)) install.packages("naniar")
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(VIM)) install.packages("VIM")
if (!require(validate)) install.packages("validate")
if (!require(validatetools)) install.packages("validatetools")
if (!require(dcmodify)) install.packages("dcmodify")
if (!require(errorlocate)) install.packages("errorlocate")
if (!require(plotly)) install.packages("plotly")
if (!require(modelsummary)) install.packages("modelsummary")

library(tidyverse)
library(dplyr)
library(naniar)
library(ggplot2)
library(VIM)
library(validate)
library(validatetools)
library(dcmodify)
library(errorlocate)
library(plotly)
library(modelsummary)

dane <- read_csv("dane/Car_Prices_Poland_Kaggle.csv")
```

# Wstęp

Celem niniejszego raportu jest analiza danych dotyczących cen samochodów w Polsce. Dane zostały pozyskane z platformy Kaggle i zawierają informacje na temat różnych modeli samochodów, ich cech oraz cen rynkowych. Analiza ma na celu zrozumienie czynników wpływających na ceny samochodów oraz identyfikację wzorców i trendów w danych.

## Opis danych

Zestaw danych pochodzi z jednego z największych portali ogłoszeniowych w Polsce. Zgromadzono w nim ponad 200 tysięcy ofert sprzedaży samochodów, obejmujących szeroki zakres marek, modeli, parametrów technicznych oraz informacji o stanie pojazdu.

Celem zbioru jest umożliwienie analizy cen, cech technicznych, profilu ofert i trendów rynkowych dotyczących samochodów używanych i nowych dostępnych na polskim rynku.

### Pytania badawcze

1.  **Jakie są średnie ceny samochodów w zależności od marki?**
2.  **Które cechy samochodów (np. rok produkcji, przebieg, moc silnika, rodzaj paliwa) mają największy wpływ na cenę pojazdu?**
3.  **Jak zmieniają się ceny samochodów w zależności od roku produkcji? Czy starsze samochody tanieją liniowo czy nieliniowo?**
4.  **Czy istnieją różnice w cenach samochodów w zależności od typu pojazdu (np. sedan, SUV, hatchback, kombi)?**
5.  **Jak przebieg pojazdu wpływa na jego cenę i czy wpływ ten różni się między markami?**
6.  **Czy rodzaj paliwa (benzyna, diesel, LPG, hybryda, elektryczny) wpływa na cenę?**

## Analiza danych

## 2.1 Braki danych

Usunięcie kolumny ..1, ponieważ nie wpływa ona na analizę.

```{r}
dane %>% select(-"...1")
```

```{r}
procent <- prop_complete_var(dane) * 100
```

W danych znajduje się `r procent` % kompletnych wartości.

```{r message=FALSE, warning=FALSE}
raport <- VIM::aggr(dane, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(dane), cex.axis=.7, gap=3, ylab=c("Procent braków danych","Wzorzec braków danych"))

raport$x
```

## Imputacje danych

```{r}
dane_imp <- hotdeck(dane)
VIM::aggr(dane_imp, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(dane_imp), cex.axis=.7, gap=3, ylab=c("Procent braków danych po imputacji","Wzorzec braków danych po imputacji"))
```

Po imputacji danych za pomocą metody hotdeck, wszystkie braki danych zostały uzupełnione.

## 2.2 Walidacja danych

### Reguły

Rozpatrzmy następujący zbiór danych. Co widzisz w początkowych wierszach?

```{r}
data(dane_imp)
head(dane_imp[3:7],3)
# dodajmy ID
dane_imp$rec_id <- sprintf("%03d",1:nrow(dane_imp))

rules <- validator(
  price >= 0
  , year > 0 & year < 2026
  , mileage >= 0
  , fuel %in% c("Diesel", "CNG", "Gasoline", "Hybrid", "Electric", "LPG")
)

cf <- confront(dane_imp, rules, key="rec_id")
summary(cf)
barplot(cf, main="Samochody - Walidacja danych")
#as.data.frame(cf) %>% head()
```

Wszystkie dane są poprawne zgodnie z ustalonymi regułami walidacji.

## 3 Wizualizacja Danych
### 3.1 Analiza Diesel + Gasoline
``` {r}
wykres_przebieg_cena_diesel <- dane_imp %>%
  filter(fuel %in% c("Diesel", "Gasoline")) %>%
ggplot(aes(x = mileage, y = price)) +
  geom_point() +
  scale_x_log10() +
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  labs(title = "Zależność pomiędzy przbeiegiem a ceną",
       x = "Przebieg (w tysiącach, log10)",
       y = "Cena (w USD)") +
  theme_minimal()
wykres_przebieg_cena_diesel
```

Opis wykresu??????

``` {r}
wykres_rok_cena_diesel <- dane_imp %>%
  filter(fuel %in% c("Diesel", "Gasoline")) %>%
  ggplot(aes(x = year, y = price, color = mark)) +
  geom_point() +
  geom_smooth(method = "loess", color = "light green", se = FALSE) +
  labs(title = "Zależność pomiędzy rokiem produkcji a ceną",
       x = "Rok produkcji",
       y = "Cena (w USD)") +
  theme_minimal()
plotly(wykres_rok_cena)
```

Opis wykresu??????

### 3.2 Analiza Hybrid + Electric
``` {r}
wykres_przebieg_cena_EV <- dane_imp %>%
  filter(fuel %in% c("Hybrid", "Electric")) %>%
  ggplot(aes(x = mileage, y = price)) +
  geom_point() +
  scale_x_log10() +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(title = "Zależność pomiędzy przbeiegiem a ceną",
       x = "Przebieg (w tysiącach, log10)",
       y = "Cena (w USD)") +
  theme_minimal()
wykres_przebieg_cena_EV
```

Opis wykresu?????

``` {r}
wykres_rok_cena_EV <- dane_imp %>%
  filter(fuel %in% c("Hybrid", "Electric")) %>%
  ggplot(aes(x = year, y = price, color = mark)) +
  geom_point() +
  geom_smooth(method = "loess", color = "light green", se = FALSE) +
  labs(title = "Zależność pomiędzy rokiem produkcji a ceną",
       x = "Rok produkcji",
       y = "Cena (w USD)") +
  theme_minimal()
plotly(wykres_rok_cena)
```

Opis wykresu???

Analiza statystyczna dla wpływu roku, przebiegu i mocy silnika na cene

``` {r}
LMP <- lm(price ~ year + mileage + vol_engine, data = dane_imp)
summary(LMP)
modelsummary(LMP)
```
Opis modelu 

``` {r}
tabela_najdrozsze_samochody <- dane_imp %>%
  filter(year >= 2010) %>%
  group_by(mark) %>%
  summarise(srednia_cena = mean(price),
            mediana_cena = median(price),
            najdroższy = max(price),
            najtańszy = min(price),
            liczba_samochodow = n()) %>%
  arrange(desc(srednia_cena))

tabela_najdrozsze_samochody
```

Wybieramy marki samochodów z najwyższą średnią ceną i analizujemy zmiane ceny w przeciągu lat.

``` {r}
wykres_srednia_cena_przez_lata <- dane_imp %>% 
  filter(mark %in% c("mercedes", "bmw", "audi", "volvo", "alfa-romeo")) %>%
  group_by(mark, year) %>%
  summarise(srednia_cena = mean(price)) %>%
  ggplot(aes(x = year, y = srednia_cena, color = mark)) +
  geom_line()
plotly(wykres_srednia_cena_przez_lata)
```

Opis wykresu????

``` {r}
wykres_rejestracje <- dane_imp %>%
  filter(year >= 1990) %>%
  group_by(mark, year) %>%
  summarise(liczba_aut_rok = n()) %>%
  ggplot(aes(x = year, y = liczba_aut_rok, color = mark)) +
  geom_line()
plotly(wykres_rejestracje)
```
Opis wykresu???